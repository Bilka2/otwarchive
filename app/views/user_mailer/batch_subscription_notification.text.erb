<% content_for :message do %>
<% @seen = {} %>
<% @seen_summary = {} %>
<% @creations.each_with_index do |creation, index| %>
<% this_work = creation.respond_to?(:work) ? creation.work : creation %>
<% dating_key = this_work.backdate ? "backdated" : "new" %>
<% work_with_word_count = creation_title_with_word_count(this_work) %>
<% cache "/v1/subscription-email-txt-preface-#{creation.cache_key}" do %>
<% if creation.is_a?(Work) && this_work.anonymous? %>
<%= t(".anon.preface.work.#{dating_key}") %>
<% elsif creation.is_a?(Chapter) && this_work.anonymous? %>
<%= t(".anon.preface.chapter.text", work_title_with_word_count: work_with_word_count) %>
<% elsif creation.is_a?(Work) %>
<%= t(".named.preface.work.#{dating_key}.text", creators: creator_text(this_work), count: this_work.creators.size) %>
<% else %>
<%= t(".named.preface.chapter.text", creators: creator_text(this_work), count: this_work.creators.size, work_title_with_word_count: work_with_word_count) %>
<% end %>
<%= creation.is_a?(Work) ? work_url(this_work) : work_chapter_url(this_work, creation) %>
<% end %>

<%= creation_title_with_word_count(creation) %><% unless @seen[this_work.id] %>
<%= creation_attribution_text(this_work) %><% end %>

<% if !creation.summary.blank? && creation.is_a?(Chapter) %>
<%= work_metadata_label(t(".chapter_summary")) %><%= raw to_plain_text(sanitize_field(creation, :summary)) %>
<% end %>

<% unless @seen[this_work.id] %>
<% cache "/v1/subscription-email-txt-meta-#{creation.cache_key}" do %>
<%= render "work_info", work: this_work, suppress_summary: true %>
<% end %><% @seen[this_work.id] = true %><% end %>

<% unless @seen_summary[this_work.id] || this_work.summary.blank? %>
<%= work_metadata_label(Work.human_attribute_name("summary")) %>
    <%= raw to_plain_text(sanitize_field(this_work, :summary)) %><% @seen_summary[this_work.id] = true %><% end %><% if (index < @creations.length-1) %>

<%= text_divider %>

<% end %><% end %><% end %>

<% content_for :footer_note do %>
<%= t(".footer_note.text", subscription_name: @subscription.name, unsubscribe_url: polymorphic_url(@subscription.subscribable)) %>
<% end %>
